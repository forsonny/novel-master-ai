---
description: Context-gathering patterns for NRDs, tasks, and manuscript files in Novel Master
globs: 
alwaysApply: false
---

# Narrative Context Gathering Patterns

This rule explains how to gather **story context** (NRDs, tasks, manuscript files, character/world notes) when calling AI-powered tools like `research`, `analyze_project_complexity`, and `expand_task`.

You should think in terms of **story artifacts**, not just source code.

---

## Core Context Sources

Use the `ContextGatherer` utility (`scripts/modules/utils/contextGatherer.js`) to combine:

- **Tasks**:
  - Outline tasks and beats from `.novelmaster/tasks/tasks.json`.
  - Target specific IDs: chapters (`12`), scenes (`12.3`), or ranges (`10,11,12.2`).
- **NRDs**:
  - Files like `.novelmaster/docs/nrd.txt`, `outline-*.md`, or per-arc NRDs.
- **Manuscript files**:
  - Chapter markdown under `.novelmaster/manuscript/chapters/`.
  - Compiled manuscripts under `.novelmaster/manuscript/compiled/`.
- **World & character notes**:
  - Any additional lore/character files the user maintains (e.g., `.novelmaster/docs/characters.md`, `worldbuilding/*.md`).

You can also include **custom text** (e.g., the user’s question or constraints) as part of the context.

---

## Usage Pattern

```javascript
import { ContextGatherer } from '../utils/contextGatherer.js';

// Initialize with project paths
const gatherer = new ContextGatherer(projectRoot, tasksPath);

// Gather narrative context with token breakdown
const result = await gatherer.gather({
  tasks: ['7', '7.2', '12'],                    // Chapter/scene IDs
  files: [
    '.novelmaster/docs/nrd.txt',               // NRD
    '.novelmaster/manuscript/chapters/chapter-07.md'
  ],
  customContext: 'Focus on Mina’s emotional arc and pacing in Act II.',
  includeProjectTree: false,                   // Often not needed for pure fiction
  format: 'research',
  includeTokenCounts: true
});

const contextString = result.context;
const tokenBreakdown = result.tokenBreakdown;
```

---

## When to Use Context Gathering

### Recommended

- **`research` tool**:
  - Worldbuilding questions (technology, culture, magic rules) grounded in existing text.
  - Consistency checks: \"Does this new scene contradict anything earlier?\"
- **`analyze_project_complexity`**:
  - When you want to correlate pacing/complexity data with actual manuscript sections.
- **`expand_task` / `update_task` / `update_subtask`**:
  - When revising beats, you should provide surrounding chapters/scenes to maintain continuity of tone and character.

### Less Useful

- Purely mechanical operations (e.g., moving tasks between tags, changing statuses) that don’t involve AI analysis or generation.

---

## Token Budget & Performance

Guidelines:

- Prefer **narrow, relevant context** over \"everything\":
  - Nearby chapters (±1–2), not the whole book, unless explicitly requested.
  - Specific NRD sections or character notes relevant to the current scene.
- Use `includeTokenCounts` to understand context size:
  - If tokens are high, trim file lists or task IDs and re-run.
- For long projects:
  - Focus `research` calls on **arcs** (e.g., \"Lena’s arc scenes only\") rather than the entire manuscript.

---

## Example Patterns

### 1. Worldbuilding Research for a Scene

Goal: help the user write a spaceport sequence that matches existing lore.

```javascript
const result = await gatherer.gather({
  tasks: ['9'], // Chapter 9 – Arrival at the Glass Port
  files: [
    '.novelmaster/docs/setting-glass-orbit.md',
    '.novelmaster/manuscript/chapters/chapter-08.md'
  ],
  customContext: 'Advise on plausible security protocols and crowd behavior in a space station bazaar.',
  format: 'research',
  includeTokenCounts: true
});
```

Then pass `result.context` into the `research` tool’s prompt.

### 2. Character Arc Consistency Check

Goal: evaluate whether Mina’s choices feel consistent from Act I to Act III.

```javascript
const result = await gatherer.gather({
  tasks: ['3', '7', '15'], // Key chapters in Mina's arc
  files: [
    '.novelmaster/manuscript/chapters/chapter-03.md',
    '.novelmaster/manuscript/chapters/chapter-07.md',
    '.novelmaster/manuscript/chapters/chapter-15.md'
  ],
  customContext: 'Assess Mina’s moral and emotional trajectory for consistency and growth.',
  format: 'research',
  includeTokenCounts: true
});
```

Use `research` with this context to generate a short report and then create/update revision tasks accordingly.

---

## Error Handling & Fallbacks

When files or tasks are missing:

- Prefer **warnings** and partial results over hard failures.
- Explain to the user which elements were missing (e.g., a chapter file not found) and what you used instead.
- For fictional projects, it’s acceptable to proceed with **NRD + available chapters**, then propose tasks to fill gaps (e.g., \"Write chapter 9 draft\").

---

## Agent Checklist

Before calling narrative AI tools that take context:

1. Decide **what question you are answering** (worldbuilding, continuity, pacing, character arc).
2. Select **the smallest set of tasks + files** that fully support that question.
3. Use `ContextGatherer` to assemble and quantify the context.
4. Pass the resulting context into `research` or other tools.
5. Turn findings into **concrete tasks** (often in `rev-1`, `rev-2`, or `beta-feedback` tags).

