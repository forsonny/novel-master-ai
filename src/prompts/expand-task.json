{
	"id": "expand-task",
	"version": "1.0.0",
	"description": "Break down a narrative task (arc/chapter) into detailed scenes or revision passes",
	"metadata": {
		"author": "system",
		"created": "2024-01-01T00:00:00Z",
		"updated": "2025-01-15T00:00:00Z",
		"tags": ["scene-breakdown", "narrative", "expansion"]
	},
	"parameters": {
		"subtaskCount": {
			"type": "number",
			"required": true,
			"description": "Number of scenes/beats to generate"
		},
		"task": {
			"type": "object",
			"required": true,
			"description": "The parent narrative task (act/arc/chapter) to expand"
		},
		"nextSubtaskId": {
			"type": "number",
			"required": true,
			"description": "Starting ID for new subtasks"
		},
		"useResearch": {
			"type": "boolean",
			"default": false,
			"description": "Use research mode for genre/world insights"
		},
		"expansionPrompt": {
			"type": "string",
			"required": false,
			"description": "Prompt from pacing/complexity report"
		},
		"additionalContext": {
			"type": "string",
			"required": false,
			"default": "",
			"description": "Additional narrative context"
		},
		"complexityReasoningContext": {
			"type": "string",
			"required": false,
			"default": "",
			"description": "Reasoning snippet from latest analysis"
		},
		"gatheredContext": {
			"type": "string",
			"required": false,
			"default": "",
			"description": "Collected project context (prior scenes, lore, etc.)"
		},
		"hasManuscriptContext": {
			"type": "boolean",
			"required": false,
			"default": false,
			"description": "Whether manuscript files are accessible"
		},
		"hasCodebaseAnalysis": {
			"type": "boolean",
			"required": false,
			"default": false,
			"description": "Deprecated: Use hasManuscriptContext instead. Whether manuscript files are accessible"
		},
		"projectRoot": {
			"type": "string",
			"required": false,
			"default": "",
			"description": "Project root path for context"
		}
	},
	"prompts": {
		"complexity-report": {
			"condition": "expansionPrompt",
			"system": "You are an AI narrative editor expanding high-level narrative tasks into concrete scenes or revision checkpoints. Generate {{#if (gt subtaskCount 0)}}exactly {{subtaskCount}}{{else}}an appropriate number of{{/if}} subtasks using the pacing guidance below. IMPORTANT: respond with a JSON object containing \"subtasks\" (array) and optional \"metadata\" only. Each subtask must include: id (sequential integers starting at {{nextSubtaskId}}), title (scene/beat label), description (what happens + emotional intent), dependencies (array), details (POV, setting, stakes, sensory cues, research hooks), status (\"pending\"), and testStrategy (continuity/pacing check).",
			"user": "Break down the following task using the provided pacing prompt.\n\nParent Task\nID: {{task.id}}\nTitle: {{task.title}}\nDescription: {{task.description}}\nCurrent details: {{#if task.details}}{{task.details}}{{else}}None{{/if}}\n\nComplexity guidance:\n{{expansionPrompt}}{{#if additionalContext}}\n\nAdditional context:\n{{additionalContext}}{{/if}}{{#if complexityReasoningContext}}\n\nAnalysis notes:\n{{complexityReasoningContext}}{{/if}}{{#if gatheredContext}}\n\n# Project Context\n{{gatheredContext}}{{/if}}\n\nGenerate {{#if (gt subtaskCount 0)}}exactly {{subtaskCount}}{{else}}an appropriate number of{{/if}} subtasks. IDs must be sequential starting at {{nextSubtaskId}}."
		},
		"research": {
			"condition": "useResearch === true && !expansionPrompt",
			"system": "You are an AI assistant with research capabilities focused on narrative craft. Before expansion, fold in any relevant lore, genre expectations, or thematic insights surfaced during research. Output must match the JSON schema described above (subtasks array with id/title/description/dependencies/details/status/testStrategy).",
			"user": "{{#if (or hasManuscriptContext hasCodebaseAnalysis)}}## OPTIONAL: Manuscript Context Available\n- Explore `.novelmaster/manuscript/**/*.md` for drafted scenes.\n- Inspect `.novelmaster/docs/research` for lore notes.\n- Respect previously written canon.\n\nProject Root: {{projectRoot}}\n{{/if}}\nAnalyze the task below and break it into {{#if (gt subtaskCount 0)}}exactly {{subtaskCount}}{{else}}an appropriate number of{{/if}} scenes or revision actions. Provide POV, emotional beat, tension curve, and sensory anchors for every subtask.\n\nParent Task\nID: {{task.id}}\nTitle: {{task.title}}\nDescription: {{task.description}}\nCurrent details: {{#if task.details}}{{task.details}}{{else}}None{{/if}}{{#if additionalContext}}\nAdditional context: {{additionalContext}}{{/if}}{{#if complexityReasoningContext}}\nAnalysis notes: {{complexityReasoningContext}}{{/if}}{{#if gatheredContext}}\n\n# Project Context\n{{gatheredContext}}{{/if}}\n\nCRITICAL: Subtask IDs must be sequential starting at {{nextSubtaskId}} (no dotted notation)."
		},
		"default": {
			"system": "You are an AI narrative editor breaking down narrative tasks into actionable scenes. Always return JSON with \"subtasks\" (array) and optional \"metadata\". Each subtask requires: id (sequential integer from {{nextSubtaskId}}), title, description (what the scene accomplishes), dependencies, details (POV, location, conflict, stakes, sensory cues, revision notes), status (\"pending\"), and testStrategy (continuity/pacing validation).",
			"user": "{{#if (or hasManuscriptContext hasCodebaseAnalysis)}}## OPTIONAL: Manuscript Context Available\nUse the Glob/Grep/Read tools to inspect `.novelmaster/**` files for previously drafted scenes. Align new subtasks with existing canon.\n\nProject Root: {{projectRoot}}\n{{/if}}\nBreak down this task into {{#if (gt subtaskCount 0)}}exactly {{subtaskCount}}{{else}}an appropriate number of{{/if}} narrative subtasks:\n\nTask ID: {{task.id}}\nTitle: {{task.title}}\nDescription: {{task.description}}\nCurrent details: {{#if task.details}}{{task.details}}{{else}}None{{/if}}{{#if additionalContext}}\nAdditional context: {{additionalContext}}{{/if}}{{#if complexityReasoningContext}}\nAnalysis notes: {{complexityReasoningContext}}{{/if}}{{#if gatheredContext}}\n\n# Project Context\n{{gatheredContext}}{{/if}}\n\nEnsure IDs are sequential starting at {{nextSubtaskId}}."
		}
	}
}
